version: "3.3"
services:
  minio:
    image: minio/minio:${MINIO_VERSION:-latest}
    container_name: minio
    environment:
      MINIO_ACCESS_KEY: access-key
      MINIO_SECRET_KEY: it-is-my-super-secret-key
    entrypoint: sh
    command: -c 'mkdir -p doc_gen_minio/export/clickhouse && minio server doc_gen_minio/export'
    ports:
      - 9010:9000
    networks:
      - clickhouse-backup

  zookeeper:
    image: zookeeper:${ZOOKEEPER_VERSION:-latest}
    container_name: zookeeper
    networks:
      - clickhouse-backup

  clickhouse:
    image: yandex/clickhouse-server:${CLICKHOUSE_VERSION:-21.3}
    container_name: clickhouse
    environment:
      TZ: UTC
    volumes:
      - ./backup-user.xml:/etc/clickhouse-server/users.d/backup-user.xml
      - ${CLICKHOUSE_BACKUP_BIN:-../../clickhouse-backup}:/usr/bin/clickhouse-backup
      - ./credentials.json:/etc/clickhouse-backup/credentials.json
      - ./server.crt:/etc/clickhouse-server/server.crt
      - ./server.key:/etc/clickhouse-server/server.key
      - ./dhparam.pem:/etc/clickhouse-server/dhparam.pem
      - ./ssl.xml:/etc/clickhouse-server/config.d/ssl.xml
      - ./storage_configuration.xml:/etc/clickhouse-server/config.d/storage_configuration.xml
      - ./cluster.xml:/etc/clickhouse-server/config.d/cluster.xml
      - ./init.sh:/docker-entrypoint-initdb.d/init.sh
      - /tmp/clickhouse-server.err.log:/var/log/clickhouse-server/clickhouse-server.err.log
      - /tmp/clickhouse-server.log:/var/log/clickhouse-server/clickhouse-server.log
    # 21.x+ check volumes in storage policy is exists, so we need create it before first run `clickhouse-server`
    entrypoint:
      - /bin/bash
    command:
      - -c
      - "bash -x /docker-entrypoint-initdb.d/init.sh && bash -x /entrypoint.sh"
    ports:
      - 9000:9000
      - 7171:7171
    networks:
      - clickhouse-backup

networks:
  clickhouse-backup:
